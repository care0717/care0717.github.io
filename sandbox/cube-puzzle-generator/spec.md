# Cube Puzzle Generator — 仕様書

## 概要

7種類の3Dポリキューブブロック（A〜G）から任意のブロックを選択し、それらを組み合わせたパズル問題を自動生成するWebアプリケーション。

## ブロック定義

各ブロックは単位立方体の集合として定義される。座標は `[x, y, z]` の整数値。

| ブロック | キューブ数 | 座標定義 | 色 |
|---------|-----------|---------|-----|
| A | 4 | `[0,0,0] [1,0,0] [1,1,0] [0,0,1]` | 青 `#3B82F6` |
| B | 4 | `[0,0,0] [1,0,0] [0,1,0] [0,0,1]` | オレンジ `#F97316` |
| C | 4 | `[0,0,0] [0,1,0] [1,0,0] [1,0,1]` | 紫 `#8B5CF6` |
| D | 4 | `[0,0,0] [1,0,0] [1,1,0] [2,1,0]` | 赤紫 `#DB2777` |
| E | 4 | `[0,0,0] [1,0,0] [2,0,0] [1,1,0]` | 赤 `#EF4444` |
| F | 4 | `[0,0,0] [1,0,0] [2,0,0] [2,1,0]` | 緑 `#22C55E` |
| G | 3 | `[0,0,0] [1,0,0] [0,1,0]` | 黄 `#EAB308` |

備考:
- A と C は鏡像（エナンチオマー）の関係
- G のみ3キューブ、他は全て4キューブ
- 全ブロックを使用すると合計27キューブ（3×3×3の立方体を構成可能）

各ブロックには3色が定義されている（`light`, `color`, `dark`）。3Dレンダリング時のライティングに使用。

## 回転パターン

各ブロックについて、3軸（X, Y, Z）の90度回転の全組み合わせから、重複を除いた固有の回転パターンを事前計算する。

回転関数:
- `rotateX([x,y,z]) → [x, -z, y]`
- `rotateY([x,y,z]) → [z, y, -x]`
- `rotateZ([x,y,z]) → [-y, x, z]`

正規化: 回転後に最小座標が原点になるよう平行移動し、座標を辞書順ソートする。正規化後の文字列表現で重複判定を行う。

基本の64パターン（4×4×4の3軸組み合わせ）に加え、追加の複合回転列でカバレッジを補完している。

## 問題生成アルゴリズム

貪欲配置 + バリデーションによるリトライ方式。

### 手順

1. 選択されたブロックをランダムな順序にシャッフル
2. 最初のブロックを座標 `(1, 1, 0)` 付近にランダムな回転で配置
3. 2個目以降のブロックについて:
   - 配置済みキューブの6方向隣接空きマスを「候補境界」として列挙
   - ブロックの全回転パターン × 候補位置（最大40箇所） × アンカーキューブの組み合わせを試行
   - 条件: グリッド範囲内（5×5×5）、重複なし、既存ブロックと隣接
4. 全ブロック配置後にバリデーション（後述）
5. 失敗時はステップ1からリトライ（最大400回）

### バリデーション: 接触面条件

全ブロック配置後、各ブロックについて「他のブロックとの面接触数」を計算する。

- 各キューブの6方向隣接を調べ、隣に別ブロックのキューブがあれば接触面 +1
- 全ブロックが2面以上の接触を持つことを要求
- 条件を満たさない場合は不採用→リトライ

この条件により、ブロック同士がしっかり噛み合ったコンパクトな形状が生成されやすくなる。

### 正規化

配置完了後、全キューブの最小座標が原点になるよう平行移動する。

## パズルID（エンコード/デコード）

各問題に対して決定的なIDを生成する。同じ配置は常に同じIDになり、IDから問題を完全に復元できる。

### ID形式

```
{ピースキー（アルファベット順）}-{Base36エンコード値}
```

例: `ADF-a3k2m`

### エンコード手順

1. 使用ピースをアルファベット順にソート
2. 各ピースについて以下を数値にパック:
   - 回転パターンのインデックス（そのピースの全回転パターン数に依存）
   - 配置位置 `(x, y, z)`（各0〜7、3ビット×3 = 9ビット）
3. BigIntに順次パック: `val = val * 回転数 + 回転idx; val = val * 8 + x; val = val * 8 + y; val = val * 8 + z`
4. BigIntをBase36（`0-9a-z`）に変換

### デコード手順

1. `-` で分割してピースキーとBase36コードを取得
2. Base36をBigIntに復元
3. ピースを逆順（末尾から）に、`z, y, x, 回転idx` を順次取り出し
4. 回転パターンテーブルから形状を復元し、座標をオフセット

## 3Dレンダリング

SVGベースのリアルタイム3Dレンダリング。

### カメラモデル

球面座標系のカメラ:
- `theta`: 水平回転角（初期値 `π/4`）
- `phi`: 仰角（初期値 `π/5.5`、範囲 `0.05` 〜 `π/2 - 0.05`）

カメラから以下の3ベクトルを算出:
- `cam`: カメラ方向（視線の逆方向）
- `right`: スクリーン右方向
- `up`: スクリーン上方向

### 投影

```
screen_x = dot(world_pos, right) * scale
screen_y = -dot(world_pos, up) * scale
```

スケール: メインビュー28、プレビュー10。

### 面の描画

各キューブの6面について:
1. **背面カリング**: 面法線とカメラ方向の内積が正（カメラに向いている）面のみ描画
2. **隣接カリング**: 隣にキューブがある面は非表示
3. **Painter's algorithm**: 面の中心とカメラ方向の内積でソート（奥から描画）

### ライティング

カメラ位置から少し右上にオフセットした仮想光源を使用。面法線と光源方向の内積から明度を計算し、各ブロックの `dark` 〜 `light` 色を補間する。

問題表示時（答え非表示）はグレースケール（`rgb(140+100d, 140+100d, 140+100d)`）。

### ドラッグ操作

- マウスドラッグ / タッチドラッグで `theta`, `phi` を更新
- 感度: `0.008 rad/px`
- `phi` は `0.05` 〜 `π/2 - 0.05` にクランプ（真上・真横を防止）

## UI構成

1. **タイトル**: "Cube Puzzle Generator"
2. **ブロック選択パネル**: A〜Gのトグルボタン（2つ以上選択で生成可能）
3. **ID読み込みパネル**: テキスト入力 + 読み込みボタン
4. **生成ボタン**: "🎲 問題を生成"
5. **問題表示エリア**:
   - パズルID（コピーボタン付き）
   - 使用ブロックのプレビュー
   - 3Dビュー（ドラッグ回転対応）
   - "👁 答えを見る" / "🔒 答えを隠す" トグル
   - "↩ 視点リセット" ボタン

## 技術スタック

- React（JSX）
- SVGレンダリング（Canvas不使用）
- BigInt（ID エンコード/デコード）
- 外部ライブラリ依存なし

## 既知の制限・今後の改善候補

- 問題生成は貪欲法のため、形状の多様性に偏りがある
- 解の一意性は保証されていない（複数の解法が存在しうる）
- バックトラッキング探索への移行で生成品質向上の余地あり
- バウンディングボックス制約の追加でよりコンパクトな形状を生成可能
